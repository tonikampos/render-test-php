# üì° Documentaci√≥n API - GaliTroco Backend

**Fecha de implementaci√≥n:** 13-14 de Octubre de 2025  
**Versi√≥n:** 1.0.0  
**Autor:** Toni Campos  
**Proyecto:** TFM - Plataforma de Intercambio de Habilidades

---

## üîó Base URL

- **Producci√≥n (Render):** `https://render-test-php-1.onrender.com`
- **Desarrollo Local:** `http://localhost/probatfm`

**Formato de endpoints:** `/api.php?resource={endpoint}`

---

## üîê Autenticaci√≥n

Todos los endpoints marcados con üîí requieren autenticaci√≥n mediante sesi√≥n PHP.

### Login
```bash
POST /api.php?resource=auth/login
Content-Type: application/json

{
  "email": "usuario@example.com",
  "password": "contrase√±a123"
}
```

**Respuesta:**
```json
{
  "success": true,
  "message": "Login exitoso",
  "data": {
    "user": {
      "id": 1,
      "nombre_usuario": "usuario",
      "email": "usuario@example.com",
      "rol": "usuario"
    },
    "token": "eyJ0eXAiOiJKV1QiLCJhbG..."
  }
}
```

---

## üìã Endpoints Implementados (13-14 Oct 2025)

## üîÑ INTERCAMBIOS

### 1. üìã Listar Mis Intercambios üîí
```http
GET /api.php?resource=intercambios
GET /api.php?resource=intercambios&estado=propuesto
```

**Par√°metros Query (opcionales):**
- `estado`: Filtrar por estado (`propuesto`, `aceptado`, `rechazado`, `completado`, `cancelado`)

**Respuesta exitosa (200):**
```json
{
  "success": true,
  "message": "OK",
  "data": [
    {
      "id": 1,
      "estado": "propuesto",
      "mensaje_propuesta": "Hola! Me interesa tu habilidad...",
      "fecha_propuesta": "2025-10-13 10:30:00+02",
  "ultima_actualizacion": "2025-10-13 10:30:00+02",
      "fecha_completado": null,
      "habilidad_ofrecida_id": 5,
      "habilidad_ofrecida_titulo": "Clases de guitarra",
      "habilidad_ofrecida_descripcion": "Ense√±o guitarra espa√±ola...",
      "habilidad_ofrecida_duracion": 60,
      "habilidad_ofrecida_categoria": "Arte y Creatividad",
      "habilidad_solicitada_id": 10,
      "habilidad_solicitada_titulo": "Reparaci√≥n de PC",
      "habilidad_solicitada_descripcion": "Arreglo ordenadores...",
      "habilidad_solicitada_duracion": 120,
      "habilidad_solicitada_categoria": "Tecnolog√≠a e Inform√°tica",
      "proponente_id": 2,
      "proponente_nombre": "usuario1",
      "proponente_ubicacion": "A Coru√±a, Galicia",
      "proponente_foto": null,
      "receptor_id": 3,
      "receptor_nombre": "usuario2",
      "receptor_ubicacion": "Santiago, Galicia",
      "receptor_foto": null
    }
  ]
}
```

**Ejemplo PowerShell:**
```powershell
# Con sesi√≥n autenticada
$intercambios = Invoke-RestMethod -Uri "https://render-test-php-1.onrender.com/api.php?resource=intercambios" -Method GET -WebSession $session
```

**Ejemplo curl:**
```bash
curl -X GET "https://render-test-php-1.onrender.com/api.php?resource=intercambios" \
  -H "Cookie: PHPSESSID=your_session_id"
```

---

### 2. üîç Obtener Intercambio Espec√≠fico üîí
```http
GET /api.php?resource=intercambios/{id}
```

**Par√°metros URL:**
- `id`: ID del intercambio

**Respuesta exitosa (200):**
```json
{
  "success": true,
  "message": "OK",
  "data": {
    "id": 1,
    "estado": "propuesto",
    "mensaje_propuesta": "Hola! Me interesa intercambiar...",
    "fecha_propuesta": "2025-10-13 10:30:00+02",
  "ultima_actualizacion": "2025-10-13 10:30:00+02",
    "fecha_completado": null,
    "notas_adicionales": null,
    "habilidad_ofrecida_id": 5,
    "habilidad_ofrecida_titulo": "Clases de guitarra",
    "habilidad_ofrecida_descripcion": "Ense√±o guitarra espa√±ola...",
    "habilidad_ofrecida_duracion": 60,
    "habilidad_ofrecida_categoria": "Arte y Creatividad",
    "habilidad_solicitada_id": 10,
    "habilidad_solicitada_titulo": "Reparaci√≥n de PC",
    "habilidad_solicitada_descripcion": "Arreglo ordenadores...",
    "habilidad_solicitada_duracion": 120,
    "habilidad_solicitada_categoria": "Tecnolog√≠a e Inform√°tica",
    "proponente_id": 2,
    "proponente_nombre": "usuario1",
    "proponente_email": "usuario1@example.com",
    "proponente_ubicacion": "A Coru√±a, Galicia",
    "proponente_foto": null,
    "receptor_id": 3,
    "receptor_nombre": "usuario2",
    "receptor_email": "usuario2@example.com",
    "receptor_ubicacion": "Santiago, Galicia",
    "receptor_foto": null
  }
}
```

**Errores posibles:**
- `404`: Intercambio no encontrado o no tienes acceso
- `401`: No autenticado

**Ejemplo PowerShell:**
```powershell
$detalle = Invoke-RestMethod -Uri "https://render-test-php-1.onrender.com/api.php?resource=intercambios/7" -Method GET -WebSession $session
```

---

### 3. ‚ú® Proponer Nuevo Intercambio üîí
```http
POST /api.php?resource=intercambios
Content-Type: application/json
```

**Body:**
```json
{
  "habilidad_ofrecida_id": 5,
  "habilidad_solicitada_id": 10,
  "mensaje_propuesta": "Hola! Me interesa mucho tu habilidad. ¬øTe interesar√≠a intercambiar?"
}
```

**Validaciones:**
- `habilidad_ofrecida_id` debe ser una habilidad tuya y estar activa
- `habilidad_solicitada_id` debe existir y estar activa
- No puedes proponer intercambios contigo mismo
- `mensaje_propuesta` es opcional

**Respuesta exitosa (201):**
```json
{
  "success": true,
  "message": "Intercambio propuesto exitosamente",
  "data": {
    "intercambio_id": 15,
    "mensaje": "Intercambio propuesto exitosamente"
  }
}
```

**L√≥gica autom√°tica:**
- Crea el intercambio en estado `propuesto`
- Crea una notificaci√≥n autom√°tica para el receptor
- Registra la fecha de propuesta

**Errores posibles:**
- `400`: Campos faltantes o inv√°lidos
- `403`: Solo puedes ofrecer tus propias habilidades
- `404`: Habilidad solicitada no existe o no est√° activa
- `401`: No autenticado

**Ejemplo PowerShell:**
```powershell
$body = @{
    habilidad_ofrecida_id = 16
    habilidad_solicitada_id = 3
    mensaje_propuesta = "Hola! Me interesa tu servicio"
} | ConvertTo-Json

$propuesta = Invoke-WebRequest -Uri "https://render-test-php-1.onrender.com/api.php?resource=intercambios" `
  -Method POST `
  -Headers @{"Content-Type"="application/json"} `
  -Body $body `
  -WebSession $session
```

---

### 4. ‚úÖ Aceptar/Rechazar/Cancelar Intercambio üîí
```http
PUT /api.php?resource=intercambios/{id}
Content-Type: application/json
```

**Body:**
```json
{
  "estado": "aceptado"
}
```

**Estados v√°lidos:**
- `aceptado`: El receptor acepta la propuesta
- `rechazado`: El receptor rechaza la propuesta
- `cancelado`: El proponente cancela su propuesta

**Permisos:**
- Solo el **receptor** puede aceptar o rechazar
- Solo el **proponente** puede cancelar
- Solo se pueden modificar intercambios en estado `propuesto`

**Respuesta exitosa (200):**
```json
{
  "success": true,
  "message": "Intercambio actualizado exitosamente",
  "data": {
    "mensaje": "Intercambio actualizado exitosamente",
    "nuevo_estado": "aceptado"
  }
}
```

**L√≥gica autom√°tica:**
- Actualiza el estado del intercambio
- Crea notificaci√≥n para el otro usuario
- Registra fecha de actualizaci√≥n

**Errores posibles:**
- `400`: Estado inv√°lido o intercambio no est√° en estado `propuesto`
- `403`: No tienes permisos para modificar este intercambio
- `404`: Intercambio no encontrado

**Ejemplo PowerShell:**
```powershell
$body = @{ estado = "aceptado" } | ConvertTo-Json
$result = Invoke-RestMethod -Uri "https://render-test-php-1.onrender.com/api.php?resource=intercambios/7" `
  -Method PUT `
  -Headers @{"Content-Type"="application/json"} `
  -Body $body `
  -WebSession $session
```

---

### 5. ‚úîÔ∏è Marcar Intercambio como Completado üîí
```http
PUT /api.php?resource=intercambios/{id}/completar
```

**Requisitos:**
- El intercambio debe estar en estado `aceptado`
- Solo los participantes (proponente o receptor) pueden marcarlo como completado
- No requiere body en la petici√≥n

**Respuesta exitosa (200):**
```json
{
  "success": true,
  "message": "Intercambio marcado como completado. Ahora puedes dejar una valoraci√≥n.",
  "data": {
    "mensaje": "Intercambio marcado como completado. Ahora puedes dejar una valoraci√≥n."
  }
}
```

**L√≥gica autom√°tica:**
- Cambia estado a `completado`
- Registra `fecha_completado`
- Crea notificaci√≥n para el otro usuario
- **Desbloquea la posibilidad de valorar** al otro usuario

**Errores posibles:**
- `400`: Solo se pueden completar intercambios aceptados
- `403`: No tienes acceso a este intercambio
- `404`: Intercambio no encontrado

**Ejemplo PowerShell:**
```powershell
$result = Invoke-RestMethod -Uri "https://render-test-php-1.onrender.com/api.php?resource=intercambios/7/completar" `
  -Method PUT `
  -WebSession $session
```

---

## üí¨ CONVERSACIONES Y MENSAJES

### 6. üìã Listar Mis Conversaciones üîí
```http
GET /api.php?resource=conversaciones
```

**Respuesta exitosa (200):**
```json
{
  "success": true,
  "message": "OK",
  "data": [
    {
      "id": 1,
      "intercambio_id": 5,
      "fecha_creacion": "2025-10-10 15:20:00+02",
      "ultima_actualizacion": "2025-10-13 18:45:00+02",
      "otro_usuario_id": 3,
      "otro_usuario_nombre": "usuario2",
      "otro_usuario_foto": null,
      "ultimo_mensaje": "Perfecto! Nos vemos el s√°bado",
      "ultimo_mensaje_fecha": "2025-10-13 18:45:00+02",
      "mensajes_no_leidos": 2
    }
  ]
}
```

**Caracter√≠sticas:**
- Lista todas las conversaciones donde el usuario es participante
- Ordena por `ultima_actualizacion` (conversaciones m√°s recientes primero)
- Incluye contador de mensajes no le√≠dos
- Muestra preview del √∫ltimo mensaje
- Identifica autom√°ticamente al "otro usuario" de la conversaci√≥n

**Ejemplo PowerShell:**
```powershell
$conversaciones = Invoke-RestMethod -Uri "https://render-test-php-1.onrender.com/api.php?resource=conversaciones" `
  -Method GET `
  -WebSession $session
```

---

### 7. üí¨ Obtener Mensajes de una Conversaci√≥n üîí
```http
GET /api.php?resource=conversaciones/{id}/mensajes
```

**Par√°metros URL:**
- `id`: ID de la conversaci√≥n

**Respuesta exitosa (200):**
```json
{
  "success": true,
  "message": "OK",
  "data": [
    {
      "id": 1,
      "conversacion_id": 1,
      "emisor_id": 2,
      "emisor_nombre": "usuario1",
      "emisor_foto": null,
      "contenido": "Hola! Me interesa tu propuesta",
      "fecha_envio": "2025-10-10 15:20:00+02",
      "leido": true,
      "fecha_lectura": "2025-10-10 16:05:00+02"
    },
    {
      "id": 2,
      "conversacion_id": 1,
      "emisor_id": 3,
      "emisor_nombre": "usuario2",
      "emisor_foto": null,
      "contenido": "Perfecto! Podemos coordinar para el s√°bado",
      "fecha_envio": "2025-10-13 18:45:00+02",
      "leido": false,
      "fecha_lectura": null
    }
  ]
}
```

**Caracter√≠sticas:**
- Ordena mensajes por fecha de env√≠o (m√°s antiguos primero)
- Incluye informaci√≥n del emisor de cada mensaje
- Muestra estado de lectura de cada mensaje
- Solo puedes ver mensajes de conversaciones donde eres participante

**Errores posibles:**
- `403`: No tienes acceso a esta conversaci√≥n
- `404`: Conversaci√≥n no encontrada

**Ejemplo PowerShell:**
```powershell
$mensajes = Invoke-RestMethod -Uri "https://render-test-php-1.onrender.com/api.php?resource=conversaciones/1/mensajes" `
  -Method GET `
  -WebSession $session
```

---

### 8. ‚ú® Crear Nueva Conversaci√≥n üîí
```http
POST /api.php?resource=conversaciones
Content-Type: application/json
```

**Body:**
```json
{
  "receptor_id": 3,
  "mensaje_inicial": "Hola! Me interesa tu habilidad de clases de ingl√©s. ¬øPodr√≠amos coordinar?"
}
```

**Campos aceptados:**
- `receptor_id` o `otro_usuario_id`: ID del usuario con quien iniciar conversaci√≥n
- `mensaje_inicial`: Primer mensaje de la conversaci√≥n

**Validaciones:**
- No puedes crear conversaci√≥n contigo mismo
- El receptor debe existir y estar activo
- Si ya existe una conversaci√≥n entre estos usuarios, env√≠a el mensaje ah√≠

**Respuesta exitosa (201):**
```json
{
  "success": true,
  "message": "Conversaci√≥n creada exitosamente",
  "data": {
    "conversacion_id": 10,
    "mensaje": "Conversaci√≥n creada exitosamente"
  }
}
```

**Respuesta si conversaci√≥n ya existe (200):**
```json
{
  "success": true,
  "message": "Mensaje enviado en conversaci√≥n existente",
  "data": {
    "conversacion_id": 5,
    "mensaje": "Mensaje enviado en conversaci√≥n existente"
  }
}
```

**L√≥gica autom√°tica:**
- Detecta conversaciones duplicadas
- Crea la conversaci√≥n y a√±ade ambos participantes
- Env√≠a el mensaje inicial
- Usa transacciones para garantizar consistencia
- Actualiza `ultima_actualizacion` de la conversaci√≥n

**Errores posibles:**
- `400`: Campos faltantes o inv√°lidos, o intento de conversaci√≥n consigo mismo
- `404`: Receptor no existe o no est√° activo

**Ejemplo PowerShell:**
```powershell
$body = @{
    receptor_id = 2
    mensaje_inicial = "Hola! Me interesa tu habilidad"
} | ConvertTo-Json

$nuevaConv = Invoke-WebRequest -Uri "https://render-test-php-1.onrender.com/api.php?resource=conversaciones" `
  -Method POST `
  -Headers @{"Content-Type"="application/json"} `
  -Body $body `
  -WebSession $session
```

---

### 9. üì§ Enviar Mensaje en Conversaci√≥n Existente üîí
```http
POST /api.php?resource=conversaciones/{id}/mensaje
Content-Type: application/json
```

**Par√°metros URL:**
- `id`: ID de la conversaci√≥n

**Body:**
```json
{
  "contenido": "Perfecto! ¬øTe viene bien el s√°bado a las 10:00?"
}
```

**Validaciones:**
- Debes ser participante de la conversaci√≥n
- El contenido no puede estar vac√≠o

**Respuesta exitosa (201):**
```json
{
  "success": true,
  "message": "Mensaje enviado exitosamente",
  "data": {
    "mensaje_id": 25,
    "mensaje": "Mensaje enviado exitosamente"
  }
}
```

**L√≥gica autom√°tica:**
- Env√≠a el mensaje
- Marca como no le√≠do (`leido = false`)
- Actualiza `ultima_actualizacion` de la conversaci√≥n
- El mensaje aparecer√° inmediatamente en GET /mensajes

**Errores posibles:**
- `400`: Contenido vac√≠o
- `403`: No eres participante de esta conversaci√≥n
- `404`: Conversaci√≥n no encontrada

**Ejemplo PowerShell:**
```powershell
$body = @{ contenido = "Perfecto! Nos vemos entonces" } | ConvertTo-Json
$mensaje = Invoke-WebRequest -Uri "https://render-test-php-1.onrender.com/api.php?resource=conversaciones/1/mensaje" `
  -Method POST `
  -Headers @{"Content-Type"="application/json"} `
  -Body $body `
  -WebSession $session
```

---

### 10. ‚úÖ Marcar Mensajes como Le√≠dos üîí
```http
PUT /api.php?resource=conversaciones/{id}/marcar-leido
```

**Par√°metros URL:**
- `id`: ID de la conversaci√≥n

**Respuesta exitosa (200):**
```json
{
  "success": true,
  "message": "Mensajes marcados como le√≠dos",
  "data": {
    "mensaje": "Mensajes marcados como le√≠dos"
  }
}
```

**L√≥gica:**
- Marca como le√≠dos **todos los mensajes no le√≠dos** de la conversaci√≥n que **NO fueron enviados por ti**
- Actualiza `leido = true` y `fecha_lectura = NOW()`
- Esto permite implementar la funcionalidad de "mensajes no le√≠dos" en el frontend

**Errores posibles:**
- `403`: No eres participante de esta conversaci√≥n
- `404`: Conversaci√≥n no encontrada

**Ejemplo PowerShell:**
```powershell
$result = Invoke-RestMethod -Uri "https://render-test-php-1.onrender.com/api.php?resource=conversaciones/1/marcar-leido" `
  -Method PUT `
  -WebSession $session
```

---

## üìä Resumen de Testing (13-14 Oct 2025)

### ‚úÖ Endpoints Probados y Funcionando
- `GET /intercambios` - Lista intercambios ‚úÖ
- `POST /intercambios` - Propone intercambio ‚úÖ
- `GET /intercambios/:id` - Detalle de intercambio ‚úÖ (arreglado telefono‚Üíubicacion)
- `PUT /intercambios/:id` - Cancelar intercambio ‚úÖ
- `PUT /intercambios/:id` - Validaci√≥n de permisos (aceptar/rechazar) ‚úÖ
- `PUT /intercambios/:id/completar` - Validaci√≥n (solo si aceptado) ‚úÖ
- `GET /conversaciones` - Lista conversaciones ‚úÖ
- `GET /habilidades` - Lista habilidades ‚úÖ
- `POST /habilidades` - Crea habilidad ‚úÖ
- `GET /categorias` - Lista categor√≠as ‚úÖ
- `POST /auth/register` - Registra usuario ‚úÖ
- `POST /auth/login` - Login ‚úÖ

### üêõ Bugs Encontrados y Arreglados
1. **GET /intercambios/:id** - Error 500 (ARREGLADO ‚úÖ)
   - **Problema:** Query SQL usaba columna `telefono` que no existe
   - **Soluci√≥n:** Cambiado a `ubicacion` en l√≠neas 153 y 159
   - **Commit:** 28efc15 - 14 Oct 2025
   - **Status:** ‚úÖ VERIFICADO - Funciona correctamente

2. **POST /conversaciones** - Error 400 (PARCIALMENTE ARREGLADO ‚ö†Ô∏è)
   - **Problema 1:** Endpoint esperaba `receptor_id` pero test usaba `otro_usuario_id`
   - **Soluci√≥n 1:** Aceptar ambos nombres + validar que receptor existe
   - **Commit:** 28efc15 - 14 Oct 2025
   - **Problema 2:** INSERT no inclu√≠a campo `intercambio_id` expl√≠citamente
   - **Soluci√≥n 2:** A√±adido `intercambio_id = NULL` en INSERT
   - **Commit:** fe343d6 - 14 Oct 2025
   - **Status:** ‚ö†Ô∏è PENDIENTE VERIFICACI√ìN - Error persiste en transacci√≥n SQL

### ‚ö†Ô∏è Limitaciones de Testing Encontradas

**Problema con usuarios seed:** Los usuarios pre-cargados en la base de datos (IDs 1-5) tienen passwords con hash incompatible, por lo que no es posible autenticarse con ellos para testing completo. Esto afecta a:

1. **Aceptar/Rechazar intercambios:** 
   - ‚úÖ Validaci√≥n de permisos funciona (solo receptor puede aceptar)
   - ‚ö†Ô∏è No se puede probar aceptaci√≥n completa (todos los intercambios de prueba tienen a mariaglez ID:2 como receptor)
   
2. **Completar intercambios:**
   - ‚úÖ Validaci√≥n funciona (solo si est√° en estado "aceptado")
   - ‚ö†Ô∏è No se puede probar completaci√≥n exitosa (requiere intercambio aceptado)

3. **Endpoints de Conversaciones:**
   - ‚úÖ GET /conversaciones funciona (devuelve array vac√≠o)
   - ‚ùå POST /conversaciones falla con error en transacci√≥n SQL (investigando)
   - ‚è∏Ô∏è GET /conversaciones/:id/mensajes - No probado (requiere conversaci√≥n existente)
   - ‚è∏Ô∏è POST /conversaciones/:id/mensaje - No probado (requiere conversaci√≥n existente)
   - ‚è∏Ô∏è PUT /conversaciones/:id/marcar-leido - No probado (requiere conversaci√≥n existente)

### üìù Recomendaciones para Testing Completo

1. **Regenerar hashes de passwords** de usuarios seed con bcrypt correcto
2. **Crear script de testing** que registre 2+ usuarios y pruebe flujo completo:
   - Usuario A crea habilidad
   - Usuario B propone intercambio
   - Usuario A acepta
   - Usuario A completa
   - Usuario B valora
3. **Debugging de POST /conversaciones:** Revisar logs de PostgreSQL en Supabase para identificar causa exacta del error en transacci√≥n

---

## üéØ C√≥digos de Respuesta

| C√≥digo | Significado | Cu√°ndo se usa |
|--------|-------------|---------------|
| 200 | OK | Operaci√≥n exitosa (GET, PUT) |
| 201 | Created | Recurso creado exitosamente (POST) |
| 400 | Bad Request | Datos inv√°lidos o faltantes |
| 401 | Unauthorized | No autenticado |
| 403 | Forbidden | No tienes permisos |
| 404 | Not Found | Recurso no encontrado |
| 500 | Internal Server Error | Error del servidor |

---

## üîß Estructura de Respuestas

### Respuesta Exitosa
```json
{
  "success": true,
  "message": "Mensaje descriptivo",
  "data": { /* datos del recurso */ }
}
```

### Respuesta de Error
```json
{
  "success": false,
  "message": "Descripci√≥n del error",
  "error": "Detalles t√©cnicos (solo en desarrollo)"
}
```

---

## üóÇÔ∏è Estructura del C√≥digo Backend

```
backend/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ index.php              # Router principal
‚îÇ   ‚îú‚îÄ‚îÄ auth.php               # Autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ usuarios.php           # Gesti√≥n de usuarios
‚îÇ   ‚îú‚îÄ‚îÄ habilidades.php        # CRUD habilidades
‚îÇ   ‚îú‚îÄ‚îÄ intercambios.php       # üÜï CRUD intercambios (13 Oct 2025)
‚îÇ   ‚îú‚îÄ‚îÄ conversaciones.php     # üÜï CRUD conversaciones (13 Oct 2025)
‚îÇ   ‚îú‚îÄ‚îÄ valoraciones.php       # Valoraciones
‚îÇ   ‚îú‚îÄ‚îÄ notificaciones.php     # Notificaciones
‚îÇ   ‚îú‚îÄ‚îÄ categorias.php         # Categor√≠as
‚îÇ   ‚îî‚îÄ‚îÄ reportes.php           # Reportes admin
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ database.php           # Conexi√≥n PostgreSQL/Supabase
‚îÇ   ‚îî‚îÄ‚îÄ cors.php               # Configuraci√≥n CORS
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ Auth.php               # Clase de autenticaci√≥n
    ‚îú‚îÄ‚îÄ Response.php           # Respuestas estandarizadas
    ‚îî‚îÄ‚îÄ EmailService.php       # Env√≠o de emails
```

---

## üìù Notas de Implementaci√≥n

### Sesiones PHP
- El sistema usa sesiones PHP para mantener autenticaci√≥n
- La sesi√≥n se almacena con una cookie `PHPSESSID`
- El `user_id` se guarda en `$_SESSION['user_id']`

### Transacciones
Los siguientes endpoints usan transacciones para garantizar consistencia:
- `POST /intercambios` - Crea intercambio + notificaci√≥n
- `POST /conversaciones` - Crea conversaci√≥n + participantes + mensaje
- `PUT /intercambios/:id` - Actualiza estado + crea notificaci√≥n

### Notificaciones Autom√°ticas
Se crean autom√°ticamente en:
- Nueva propuesta de intercambio ‚Üí Notifica al receptor
- Intercambio aceptado/rechazado ‚Üí Notifica al proponente
- Intercambio completado ‚Üí Notifica al otro usuario
- Nuevo mensaje ‚Üí (Pendiente implementar)

### Validaciones de Negocio
- **Intercambios:** Solo puedes ofrecer habilidades tuyas y activas
- **Conversaciones:** No puedes crear conversaci√≥n contigo mismo
- **Acceso:** Solo puedes ver/modificar tus propios recursos

---

## üöÄ Deploy en Render

**URL Producci√≥n:** https://render-test-php-1.onrender.com

**Auto-deploy:** Activado desde branch `main`

**√öltima actualizaci√≥n:** 14 de Octubre de 2025, 00:15 CEST

---

## üë®‚Äçüíª Informaci√≥n del Proyecto

**TFM - Universitat Oberta de Catalunya (UOC)**  
**M√°ster:** Desarrollo de Sitios y Aplicaciones Web  
**Alumno:** Toni Kampos  
**Email:** toni.vendecasa@gmail.com  
**GitHub:** https://github.com/tonikampos/render-test-php

---

## üìÖ Historial de Cambios

### 14 de Octubre de 2025
- ‚úÖ Implementaci√≥n completa de `intercambios.php` (524 l√≠neas)
- ‚úÖ Implementaci√≥n completa de `conversaciones.php` (393 l√≠neas)
- ‚úÖ Testing de endpoints principales
- üêõ Bug fix: Query SQL en `GET /intercambios/:id`
- üêõ Bug fix: Validaci√≥n en `POST /conversaciones`
- ‚úÖ Deploy en Render.com
- üìù Documentaci√≥n API completa

### 13 de Octubre de 2025
- ‚úÖ Creaci√≥n del esquema completo en Supabase (14 tablas)
- ‚úÖ Carga de datos seed (5 usuarios, 15 habilidades, 5 intercambios, etc.)
- ‚úÖ Implementaci√≥n inicial de endpoints

---

**Fin de la documentaci√≥n** üéâ
